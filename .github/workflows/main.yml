name: Blog Automation - Publication automatique

on:
  # DÃ©clenche tous les 2 jours Ã  9h00 UTC (11h00 heure franÃ§aise)
  schedule:
    - cron: '0 9 */2 * *'
  
  # Permet de dÃ©clencher manuellement le workflow
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Forcer la publication'
        required: false
        default: 'false'
        type: boolean

# Permissions nÃ©cessaires
permissions:
  contents: write

jobs:
  publish-blog-article:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: |
        npm ci --legacy-peer-deps
        npm install node-fetch@2

    - name: ðŸ” Verify environment
      run: |
        echo "Node version: $(node --version)"
        echo "Working directory: $(pwd)"
        ls -la scripts/

    - name: ðŸ¤– Run blog automation
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      run: |
        echo "ðŸš€ DÃ©marrage de l'automatisation blog..."
        node scripts/auto-publish-blog.js

    - name: ðŸ“ Check for changes
      id: changes
      run: |
        if git diff --quiet && git diff --cached --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“­ Aucun nouvel article Ã  publier"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Nouveaux changements dÃ©tectÃ©s"
          git status
        fi

    - name: ðŸ”„ Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Blog Automation Bot"
        
        # Ajouter les fichiers modifiÃ©s
        git add content/blog/
        git add pages/sitemap.xml.tsx || true
        
        # CrÃ©er un commit
        ARTICLE_COUNT=$(git diff --cached --name-only content/blog/ | wc -l)
        if [ $ARTICLE_COUNT -gt 0 ]; then
          ARTICLE_NAME=$(git diff --cached --name-only content/blog/ | head -1 | xargs basename -s .md)
          git commit -m "ðŸ¤– Publication automatique: $ARTICLE_NAME

          - Nouvel article publiÃ© depuis Airtable
          - Images rÃ©cupÃ©rÃ©es depuis Airtable  
          - PrÃªt pour dÃ©ploiement Netlify"
        else
          git commit -m "ðŸ¤– Mise Ã  jour automatique du blog"
        fi
        
        # Pousser les changements
        git push

    - name: âœ… Success notification
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "âœ… Article publiÃ© avec succÃ¨s !"
        echo "ðŸš€ Netlify va automatiquement dÃ©ployer"
        echo "ðŸ“… Prochain dÃ©clenchement dans 2 jours"

    - name: ðŸ“­ No changes notification
      if: steps.changes.outputs.changes == 'false'
      run: |
        echo "ðŸ“­ Aucun article programmÃ© pour aujourd'hui"
        echo "ðŸ“… Prochain dÃ©clenchement dans 2 jours"

    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸ“Š RÃ©sumÃ© de l'exÃ©cution" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Changements**: ${{ steps.changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Prochain dÃ©clenchement**: Dans 2 jours Ã  11h00" >> $GITHUB_STEP_SUMMARY
